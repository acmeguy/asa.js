!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("whatwg-fetch")):"function"==typeof define&&define.amd?define(["whatwg-fetch"],t):t()}(0,function(){"use strict";var e="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},t=setTimeout;function n(){}function o(e){if(!(this instanceof o))throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],c(e,this)}function r(e,t){for(;3===e._state;)e=e._value;0!==e._state?(e._handled=!0,o._immediateFn(function(){var n=1===e._state?t.onFulfilled:t.onRejected;if(null!==n){var o;try{o=n(e._value)}catch(e){return void i(t.promise,e)}s(t.promise,o)}else(1===e._state?s:i)(t.promise,e._value)})):e._deferreds.push(t)}function s(e,t){try{if(t===e)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var n=t.then;if(t instanceof o)return e._state=3,e._value=t,void a(e);if("function"==typeof n)return void c((r=n,s=t,function(){r.apply(s,arguments)}),e)}e._state=1,e._value=t,a(e)}catch(t){i(e,t)}var r,s}function i(e,t){e._state=2,e._value=t,a(e)}function a(e){2===e._state&&0===e._deferreds.length&&o._immediateFn(function(){e._handled||o._unhandledRejectionFn(e._value)});for(var t=0,n=e._deferreds.length;t<n;t++)r(e,e._deferreds[t]);e._deferreds=null}function c(e,t){var n=!1;try{e(function(e){n||(n=!0,s(t,e))},function(e){n||(n=!0,i(t,e))})}catch(e){if(n)return;n=!0,i(t,e)}}o.prototype.catch=function(e){return this.then(null,e)},o.prototype.then=function(e,t){var o=new this.constructor(n);return r(this,new function(e,t,n){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=n}(e,t,o)),o},o.prototype.finally=function(e){var t=this.constructor;return this.then(function(n){return t.resolve(e()).then(function(){return n})},function(n){return t.resolve(e()).then(function(){return t.reject(n)})})},o.all=function(e){return new o(function(t,n){if(!e||void 0===e.length)throw new TypeError("Promise.all accepts an array");var o=Array.prototype.slice.call(e);if(0===o.length)return t([]);var r=o.length;function s(e,i){try{if(i&&("object"==typeof i||"function"==typeof i)){var a=i.then;if("function"==typeof a)return void a.call(i,function(t){s(e,t)},n)}o[e]=i,0==--r&&t(o)}catch(e){n(e)}}for(var i=0;i<o.length;i++)s(i,o[i])})},o.resolve=function(e){return e&&"object"==typeof e&&e.constructor===o?e:new o(function(t){t(e)})},o.reject=function(e){return new o(function(t,n){n(e)})},o.race=function(e){return new o(function(t,n){for(var o=0,r=e.length;o<r;o++)e[o].then(t,n)})},o._immediateFn="function"==typeof setImmediate&&function(e){setImmediate(e)}||function(e){t(e,0)},o._unhandledRejectionFn=function(e){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",e)};var d=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==e)return e;throw new Error("unable to locate global object")}();d.Promise||(d.Promise=o),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}),String.prototype.endsWith||(String.prototype.endsWith=function(e,t){const n=this.toString();("number"!=typeof t||!isFinite(t)||Math.floor(t)!==t||t>n.length)&&(t=n.length),t-=e.length;const o=n.indexOf(e,t);return-1!==o&&o===t});const u={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/};var h=new class{constructor(e={}){this.options=u,this.options=Object.assign({},this.options,e)}parseURI(e){const t=this.options.parser.exec(e),n={};let o=14;for(;o--;)n[this.options.key[o]]=t[o]||"";return n[this.options.q.name]={},n[this.options.key[12]].replace(this.options.q.parser,(e,t,o)=>{t&&(n[this.options.q.name][t]=o)}),n}};const p={sessionStorage:window.sessionStorage,location:window.location,set asa(e){window.asa=e},get asa(){return window.asa}},f={location:document.location,referrer:document.referrer},{sessionStorage:m}=p;const l=["utm_medium","utm_source","utm_campaign","utm_content","utm_term"];var g=()=>{const e=f.referrer&&new URL(f.referrer),t=f.location&&new URL(f.location),n=l.reduce((n,o)=>{const r=e&&e.searchParams.get(o)||t&&t.searchParams.get(o)||m.getItem(`__as.${o}`);return r?Object.assign({},n,{[o]:r}):n},null);return n&&new class{constructor(e,t,n,o,r){this.campaign=e,this.medium=t,this.source=n,this.content=o,this.term=r}}(n.utm_campaign,n.utm_medium,n.utm_source,n.utm_content,n.utm_term)};const _=()=>{h.parseURI(f.referrer).authority!==h.parseURI(p.location.origin).authority&&(()=>{const e=h.parseURI(p.location.href),t=decodeURIComponent(e.queryKey.__asa||"").split("|");let n,o;t&&(n=t[0],o=t[1]),l.forEach(t=>{const n=decodeURIComponent(e.queryKey[t]||"");n?p.sessionStorage.setItem(`__as.${t}`,n):p.sessionStorage.removeItem(`__as.${t}`)}),n?p.sessionStorage.setItem("__as.PARTNER_ID",n):p.sessionStorage.removeItem("__as.PARTNER_ID"),o?p.sessionStorage.setItem("__as.PARTNER_SID",o):p.sessionStorage.removeItem("__as.PARTNER_SID")})()},v=()=>p.sessionStorage.getItem("__as.PARTNER_ID"),y=()=>p.sessionStorage.getItem("__as.PARTNER_SID");console.log||(window.console.log=(()=>{}));const w=(...e)=>{},b=console.log.bind(console,"asa.js");let I=w;const $=(...e)=>I(...e),S=e=>{I=e?b:w},E=b,R=e=>{let t,n,o=1,r=0;if(e)for(o=0,t=e.length-1;t>=0;t--)o=0!=(r=266338304&(o=(o<<6&268435455)+(n=e.charCodeAt(t))+(n<<14)))?o^r>>21:o;return o},T=()=>Math.round(Math.random()*Date.now());var x={getItem:e=>e&&decodeURIComponent(document.cookie.replace(new RegExp(`(?:(?:^|.*;)\\s*${encodeURIComponent(e).replace(/[\-\.\+\*]/g,"\\$&")}\\s*\\=\\s*([^;]*).*$)|^.*$`),"$1"))||null,setItem(e,t,n,o,r,s){if(!e||/^(?:expires|max\-age|path|domain|secure)$/i.test(e))return!1;let i="";if(n)switch(n.constructor){case Number:i=n===1/0?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":`; max-age=${n}`;break;case String:i=`; expires=${n}`;break;case Date:i=`; expires=${n.toUTCString()}`}return document.cookie=`${encodeURIComponent(e)}=${encodeURIComponent(t)}${i}${r?`; domain=${r}`:""}${o?`; path=${o}`:""}${s?"; secure":""}`,!0},removeItem(e,t,n){return!!this.hasItem(e)&&(document.cookie=`${encodeURIComponent(e)}=; expires=Thu, 01 Jan 1970 00:00:00 GMT${n?`; domain=${n}`:""}${t?`; path=${t}`:""}`,!0)},hasItem:e=>!(!e||/^(?:expires|max\-age|path|domain|secure)$/i.test(e))&&new RegExp(`(?:^|;\\s*)${encodeURIComponent(e).replace(/[\-\.\+\*]/g,"\\$&")}\\s*\\=`).test(document.cookie),keys(){const e=document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/);for(let t=e.length,n=0;n<t;n++)e[n]=decodeURIComponent(e[n]);return e}};let O=!1;const U=()=>x.setItem("__as_user",(()=>`${R(p.location.host)}.${R(`${T()}`)}`)(),1/0,"/"),j=()=>{x.getItem("__as_user")||(O=!0,U());let e=x.getItem("__as_user");return(e.length>70||e.length<40)&&(U(),e=x.getItem("__as_user")),e},k=()=>!!O&&(O=!1,!0);let F={};const P=()=>{const e=[];for(const t in F)F.hasOwnProperty(t)&&F[t]&&e.push(t);return e.join(".")},D=1,C=1,M=77,N=()=>[D,C,M].join(".")+(P()?`-${P()}`:""),q=(e,t)=>fetch(e,{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"text/plain; charset=UTF-8"}}),A=e=>(e=>q("//inbox.activitystream.com/asa",e))({ev:e,t:(e=>{const t=e=>e<10?`0${e}`:e;return`${e.getFullYear()}-${t(e.getMonth()+1)}-${t(e.getDate())}T${t(e.getHours())}:${t(e.getMinutes())}:${t(e.getSeconds())}.${(e.getMilliseconds()/1e3).toFixed(3).slice(2,5)}${(e=>{const n=t(Math.abs(Math.floor(e/60))),o=t(Math.abs(e%60));return`${(e>0?"-":"+")+n}:${o}`})(e.getTimezoneOffset())}`})(new Date)}),J=(e,t)=>e&&(22===e.code||18===e.code)||(e=>q("//inbox.activitystream.com/asa/error",e))({err:e,context:t,v:N()});var W=new class{constructor(){this._dispatchEvent=A,this._dispatchError=J,this.pendingSubmission=[],this.done=!0}batchEvent(e){this.pendingSubmission.push(e)}get submitEvent(){return this._dispatchEvent}get submitError(){return this._dispatchError}batchOn(){this.batchIntervalHandler=setInterval(()=>{try{if(this.pendingSubmission.length>0&&this.done){const e=Math.min(this.pendingSubmission.length,10),t=this.pendingSubmission.slice(0,e);this.done=!1,A(t).then(()=>this.pendingSubmission.splice(0,t.length)).catch($)}}catch(e){$("exception submitting",e)}},400)}batchOff(){this.batchIntervalHandler?clearInterval(this.batchIntervalHandler):$("cannot batch off, it is not on")}override(e=this._dispatchEvent,t=this._dispatchError){this._dispatchError=t,this._dispatchEvent=e}reset(){this._dispatchError=J,this._dispatchEvent=A}};const K=(e,t)=>{for(const n in t)t.hasOwnProperty(n)&&void 0!==t[n]&&(e[n]=t[n])},L=(e,t)=>{if(!e&&!t)return;if(!e&&t)return t;if(e&&!t)return e;const n={};return K(n,e),K(n,t),n},H={get(e){try{return x.getItem(e)}catch(t){throw new Error(`Error while trying to get item from session cookie:${e}`)}},set(e,t){try{return x.setItem(e,t,1/0,"/")}catch(n){throw new Error(`Error while trying to set item to session cookie: "${e}" <- ${t}`)}},remove:e=>{try{x.removeItem(e)}catch(t){throw new Error(`Error while trying to remove item from session cookie: "${e}`)}}},G={hasItem:H.get,getItem:H.get,setItem:H.set,removeItem:H.remove};let z={hasSession(){const e=G.hasItem("__asa_session");try{return e&&JSON.parse(e).t>new Date}catch(e){return!1}},createSession(e){G.setItem("__asa_session",JSON.stringify(L(e,{id:`${(()=>R(p.location.host))()}.${R(`${j()}.${T()}`)}`,t:(new Date).getTime()+18e5})))},destroySession:()=>G.removeItem("__asa_session"),getSession:()=>JSON.parse(G.getItem("__asa_session")),updateTimeout:function(e){let t=this.getSession();const n=t.id;(t=L(t,e)).t=(new Date).getTime()+18e5,t.id=n,G.setItem("__asa_session",JSON.stringify(t))}};const B=()=>z.getSession(),Y=()=>!!z.hasSession(),Q=e=>z.createSession(e),V=()=>z.destroySession(),X=(e,t,n)=>z=((e,t,n,o,r)=>({hasSession:e,createSession:n,getSession:t,destroySession:o,updateTimeout:r}))(e,t,n,V,Z),Z=e=>z.updateTimeout(e);var ee;!function(e){let t;!function(e){e[e["debug.mode.enabled"]=0]="debug.mode.enabled",e[e["page.viewed"]=1]="page.viewed",e[e["session.started"]=2]="session.started",e[e["session.resumed"]=3]="session.resumed",e[e["tenant.id.provided"]=4]="tenant.id.provided",e[e["custom.session.created"]=5]="custom.session.created",e[e["microdata.transformer.provided"]=6]="microdata.transformer.provided",e[e["connected.partners.provided"]=7]="connected.partners.provided",e[e["service.providers.provided"]=8]="service.providers.provided",e[e["as.web.customer.account.provided"]=9]="as.web.customer.account.provided",e[e["as.web.order.reviewed"]=10]="as.web.order.reviewed",e[e["as.web.product.availability.checked"]=11]="as.web.product.availability.checked",e[e["as.web.product.carted"]=12]="as.web.product.carted",e[e["as.web.product.searched"]=13]="as.web.product.searched",e[e["as.web.product.shipping.selected"]=14]="as.web.product.shipping.selected",e[e["as.web.product.viewed"]=15]="as.web.product.viewed",e[e["as.web.payment.completed"]=16]="as.web.payment.completed"}(t=e.Type||(e.Type={}));e.WebEvent=class{constructor(e,t){const{id:n,referrer:o,campaign:r}=B(),s=v(),i=y();this.origin=p.location.origin,this.occurred=new Date,r&&(this.campaign=r),this.user={did:j(),sid:n},this.page={url:p.location.href},o&&(this.page.referrer=o),this.type=e,this.tenant_id=p.asa.id,s&&(this.partner_id=s),i&&(this.partner_sid=i),this.title=document.title,this.location=p.location.href,this.v=N(),Object.assign(this,t)}toJSON(){return Object.assign({},this,{type:t[this.type]})}}}(ee||(ee={}));var te=(e,t,n)=>{if(t&&t.length>0){const o=h.parseURI(t).authority;if(o!=h.parseURI(e).authority&&-1===n.indexOf(o))return t}return null};function ne(e){let t=[];_();const n=function(e,o,...r){try{if(e===ee.Type["custom.session.created"])return void X(o,r[0],r[1]);if(e===ee.Type["connected.partners.provided"])return void function(e){const t=e,n=({target:e})=>{let n=e.href;if(n){const o=h.parseURI(n);if(t.indexOf(o.authority)>-1){if(!o.queryKey.__asa){const t=-1!==e.href.indexOf("?");n=`${n+(t?"&":"?")}__asa=${encodeURIComponent(`${p.asa.id}|${B().id}`)}`,e.href=n}const t={};if(["utm_medium","utm_source","utm_campaign","utm_content","utm_term"].forEach(e=>{const n=p.sessionStorage.getItem(`__as.${e}`);n&&(t[e]=n)}),Object.keys(t).length&&!Object.keys(o.queryKey).some(e=>-1!==e.indexOf("utm_"))){const o=-1!==n.indexOf("?");Object.keys(t).forEach((e,r)=>{n=`${n+(o||0!==r?"&":"?")+e}=${encodeURIComponent(t[e])}`}),e.href=n}}}};document.addEventListener("mousedown",n),document.addEventListener("keyup",n),document.addEventListener("touchstart",n)}(o);if(e===ee.Type["service.providers.provided"])return void(t=o);if(e===ee.Type["tenant.id.provided"])return void(p.asa.id=o);if(e===ee.Type["debug.mode.enabled"])return void S(o);if(e===ee.Type["microdata.transformer.provided"])return;const s=g(),i=te(f.location,f.referrer,t);if(Y()){const e=h.parseURI(f.referrer).authority;e!==h.parseURI(f.location).authority&&-1===t.indexOf(e)&&(Z({campaign:s,referrer:i}),$("session resumed"),n.transport(new ee.WebEvent(ee.Type["session.resumed"])))}else $("no session, starting a new one"),Q({campaign:s,referrer:i}),n.transport(new ee.WebEvent(ee.Type["session.started"],{newBrowser:k()}));n.transport(new ee.WebEvent(e,o))}catch(t){E("inbox exception:",t),W.submitError(t,{location:"processing inbox message",arguments:[e,o,...r]})}return n};return n.id=e,n.transport=(e=>(W.submitEvent(e),n)),n}((e=[])=>{try{const t=window.asa&&window.asa.q||[];window.asa=new ne,window.WebEvent=ee.Type,_(),(e=>{(e=e||[])instanceof Array||(e=[e]);for(let t=0;t<e.length;t++)window.asa.apply(null,e[t])})(e);for(let e=0;e<t.length;e++)window.asa.apply(null,t[e])}catch(e){E("exception during init: ",e),W.submitError(e,{location:"boot script"})}})()});
