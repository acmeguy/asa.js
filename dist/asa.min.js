!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("promise-polyfill/src/polyfill"),require("whatwg-url"),require("whatwg-fetch")):"function"==typeof define&&define.amd?define(["promise-polyfill/src/polyfill","whatwg-url","whatwg-fetch"],t):t(e.Promise,null)}(this,function(e,t){"use strict";if(String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}),String.prototype.endsWith||(String.prototype.endsWith=function(e,t){var n=this.toString();("number"!=typeof t||!isFinite(t)||Math.floor(t)!==t||t>n.length)&&(t=n.length),t-=e.length;var r=n.indexOf(e,t);return-1!==r&&r===t}),window.localStorage)try{localStorage.localStorage=1,delete localStorage.localStorage}catch(e){var n=function(){var e={};return{setItem:function(t,n){e[t]=n},getItem:function(t){return e[t]},removeItem:function(t){delete e[t]}}},r=n(),o=n();Object.defineProperties(window,{localStorage:{get:function(){return r}},sessionStorage:{get:function(){return o}}})}window.URL||Object.defineProperties(window,{URL:{get:function(){return function(e){var n=document.createElement("a");return n.href=e,n.searchParams=new t.URLSearchParams(n.search),n}}}});var i={sessionStorage:window.sessionStorage,location:window.location},a={location:document.location,referrer:document.referrer},s={utm_campaign:["utm_campaign"],utm_medium:["utm_medium"],utm_source:["utm_source"],utm_content:["utm_content"],utm_term:["utm_term"]},c=function(){var e=a.referrer&&new URL(a.referrer),t=a.location&&new URL(a.location),n={};return u(function(r,o){var a=o.map(function(n){return e&&e.searchParams.get(n)||t&&t.searchParams.get(n)||i.sessionStorage.getItem("__as."+n)}).find(Boolean);a&&(n[r.substr(4)]=a)}),n},u=function(e){return Object.keys(s).map(function(t){return e(t,s[t])})},f=function(e){Object.keys(e).forEach(function(t){s[t]=s[t].concat(e[t])})},l={PARTNER_ID_KEY:"__as.partner_id",PARTNER_SID_KEY:"__as.partner_sid"},m=function(e,t){return t&&(l[e]=t,h()),l[e]},h=function(){var e=a.location&&new URL(a.location),t=e.searchParams.get(m("PARTNER_ID_KEY"))||"",n=e.searchParams.get(m("PARTNER_SID_KEY"))||"";u(function(t,n){var r=n.map(function(t){return decodeURIComponent(e.searchParams.get(t)||"")}).find(Boolean)||"";r?i.sessionStorage.setItem("__as."+t,r):i.sessionStorage.removeItem("__as."+t)}),t?i.sessionStorage.setItem(m("PARTNER_ID_KEY"),t):i.sessionStorage.removeItem(m("PARTNER_ID_KEY")),n?i.sessionStorage.setItem(m("PARTNER_SID_KEY"),n):i.sessionStorage.removeItem(m("PARTNER_SID_KEY"))},d=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},g=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),p=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t};console||(window.console={}),console.log||(window.console.log=function(){});var v=new(function(){function e(){d(this,e),this._logger=e.none}return g(e,[{key:"mode",value:function(t){this._logger=t?e.console:e.none}},{key:"log",value:function(){this._logger.apply(this,arguments)}},{key:"force",value:function(){e.console.apply(e,arguments)}}],[{key:"none",value:function(){}},{key:"console",value:function(e){function t(){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(){for(var e,t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];(e=console).log.apply(e,["js"].concat(n))})}]),e}()),y=function(){return Math.round(Math.random()*Date.now())},_=0;function w(e){return function(e){for(var t=_?"0123456789ABCDEF":"0123456789abcdef",n="",r=void 0,o=0;o<e.length;o++)r=e.charCodeAt(o),n+=t.charAt(r>>>4&15)+t.charAt(15&r);return n}(function(e){return function(e){for(var t="",n=0;n<32*e.length;n+=8)t+=String.fromCharCode(e[n>>5]>>>24-n%32&255);return t}(function(e,t){e[t>>5]|=128<<24-t%32,e[15+(t+64>>9<<4)]=t;for(var n=Array(80),r=1732584193,o=-271733879,i=-1732584194,a=271733878,s=-1009589776,c=0;c<e.length;c+=16){for(var u=r,f=o,l=i,m=a,h=s,d=0;d<80;d++){n[d]=d<16?e[c+d]:I(n[d-3]^n[d-8]^n[d-14]^n[d-16],1);var g=E(E(I(r,5),b(d,o,i,a)),E(E(s,n[d]),S(d)));s=a,a=i,i=I(o,30),o=r,r=g}r=E(r,u),o=E(o,f),i=E(i,l),a=E(a,m),s=E(s,h)}return Array(r,o,i,a,s)}(function(e){for(var t=Array(e.length>>2),n=0;n<t.length;n++)t[n]=0;for(var r=0;r<8*e.length;r+=8)t[r>>5]|=(255&e.charCodeAt(r/8))<<24-r%32;return t}(e),8*e.length))}(function(e){var t="",n=-1,r=void 0,o=void 0;for(;++n<e.length;)r=e.charCodeAt(n),o=n+1<e.length?e.charCodeAt(n+1):0,55296<=r&&r<=56319&&56320<=o&&o<=57343&&(r=65536+((1023&r)<<10)+(1023&o),n++),r<=127?t+=String.fromCharCode(r):r<=2047?t+=String.fromCharCode(192|r>>>6&31,128|63&r):r<=65535?t+=String.fromCharCode(224|r>>>12&15,128|r>>>6&63,128|63&r):r<=2097151&&(t+=String.fromCharCode(240|r>>>18&7,128|r>>>12&63,128|r>>>6&63,128|63&r));return t}(e)))}function b(e,t,n,r){return e<20?t&n|~t&r:e<40?t^n^r:e<60?t&n|t&r|n&r:t^n^r}function S(e){return e<20?1518500249:e<40?1859775393:e<60?-1894007588:-899497514}function E(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}function I(e,t){return e<<t|e>>>32-t}var R={getItem:function(e){return e&&decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(e).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setItem:function(e,t,n,r,o,i){if(!e||/^(?:expires|max\-age|path|domain|secure)$/i.test(e))return!1;var a="";if(n)switch(n.constructor){case Number:a=n===1/0?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+n;break;case String:a="; expires="+n;break;case Date:a="; expires="+n.toUTCString()}return document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(t)+a+(o?"; domain="+o:"")+(r?"; path="+r:"")+(i?"; secure":""),!0},removeItem:function(e,t,n){return!!this.hasItem(e)&&(document.cookie=encodeURIComponent(e)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(n?"; domain="+n:"")+(t?"; path="+t:""),!0)},hasItem:function(e){return!(!e||/^(?:expires|max\-age|path|domain|secure)$/i.test(e))&&new RegExp("(?:^|;\\s*)"+encodeURIComponent(e).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)},keys:function(){for(var e=document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/),t=e.length,n=0;n<t;n++)e[n]=decodeURIComponent(e[n]);return e}},k=function(){var e=P()+"."+w(y());return R.setItem("__as_user",e,1/0,"/"),e},A=function(){var e=R.getItem("__as_user");return(!e||e.length>70||e.length<40)&&(e=k()),e},P=function(){return w(i.location.host)},O={get:function(e){try{return R.getItem(e)}catch(t){throw new Error("Error while trying to get item from session cookie:"+e)}},set:function(e,t){try{return R.setItem(e,t,1/0,"/")}catch(n){throw new Error('Error while trying to set item to session cookie: "'+e+'" <- '+t)}},remove:function(e){try{R.removeItem(e)}catch(t){throw new Error('Error while trying to remove item from session cookie: "'+e)}}},x={hasItem:O.get,getItem:O.get,setItem:O.set,removeItem:O.remove},C=function(){function e(){d(this,e)}return g(e,[{key:"hasSession",value:function(){try{return!!(U().t>Date.now())}catch(e){return!1}}},{key:"createSession",value:function(e){var t=c();x.setItem("__asa_session",JSON.stringify(Object.assign({},e,t&&{campaign:t},{id:P()+"."+w(A()+"."+y()),t:Date.now()+18e5})))}},{key:"destroySession",value:function(){return x.removeItem("__asa_session")}},{key:"getSession",value:function(){return JSON.parse(x.getItem("__asa_session")||"{}")}},{key:"refreshSession",value:function(e){var t=c(),n=Object.assign({},this.getSession(),t&&{campaign:t},e,{t:Date.now()+18e5});x.setItem("__asa_session",JSON.stringify(n))}}]),e}(),D=new C,T=function(e,t,n){D=new(function(r){function o(){return d(this,o),p(this,(o.__proto__||Object.getPrototypeOf(o)).apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(o,C),g(o,[{key:"hasSession",value:function(){return e()}},{key:"getSession",value:function(){return t()}},{key:"createSession",value:function(e){n(e)}}]),o}())},U=function(){return D.getSession()},N=function(e){return D.createSession(e)},j=function(){return D.hasSession()},K=function(e){return D.refreshSession(e)},L=function(){var e=document.querySelector('head > meta[name="keywords"]');return Y(Array.prototype.reduce.call(document.querySelectorAll('head > meta[property^="og:"]'),function(e,t){return Object.assign({},e,(n={},r=t.getAttribute("property"),o=t.getAttribute("content"),r in n?Object.defineProperty(n,r,{value:o,enumerable:!0,configurable:!0,writable:!0}):n[r]=o,n));var n,r,o},{keywords:e&&e.getAttribute("content")}))},Y=function(e,t){return e},F=function(e){Y=function(t,n){try{return e(t,n)}catch(e){return t}}},M=function(e){return e&&"href"in e},$=function(e){return e&&"form"in e};var q,J=function(e){var t=U(),n=t.id,r=t.referrer,o=t.campaign,a=t.tenant,s=L(),c=i.sessionStorage.getItem(m("PARTNER_ID_KEY"))||"",u=i.sessionStorage.getItem(m("PARTNER_SID_KEY"))||"",f=i.location.origin,l=new Date,h={url:i.location.href,referrer:r};return{type:e,partner_id:c,partner_sid:u,origin:f,occurred:l,campaign:o,title:document.title.toString(),user:{did:A(),sid:n},page:h,meta:s,tenant:a,v:"1.1.78"}};!function(e){e.Email="Email"}(q||(q={}));var B={"as.web.session.started":function(){return J("as.web.session.started")},"as.web.session.resumed":function(){return J("as.web.session.resumed")},"as.web.product.viewed":function(e){var t=J("as.web.product.viewed");return t.products=e.map(function(e){return"string"==typeof e?e:e.type?e.type+"/"+e.id:e.id}),t},"as.web.payment.completed":function(e){var t=J("as.web.payment.completed");return t.orders=e.map(function(e){return"string"==typeof e?e:e.type?e.type+"/"+e.id:e.id}),t}},H=function(e,t){return("0"+Math.abs(t)).slice(-e)},G=function(e,t){return fetch(e,{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"text/plain; charset=UTF-8"}})},W=function(e){return t={tid:"web.asa",ev:e,t:(n=new Date,r=-n.getTimezoneOffset(),o=new Date(n),o.setMinutes(n.getMinutes()+r),o.toISOString().slice(0,-1)+(~Math.sign(r)?"+":"-")+H(2,r/60)+":"+H(2,r%60))},G("//inbox2.activitystream.com/asa",t);var t,n,r,o},z=function(e,t){return G("//inbox2.activitystream.com/asa/error",{err:e,context:t,v:"1.1.78"})},Q=new(function(){function e(){var t=this;d(this,e),this._dispatchEvent=W,this._dispatchError=z,this.pendingSubmission=[],this.done=!0,this.submitEvent=function(e){return t._dispatchEvent(e)},this.submitError=function(e,n){return t._dispatchError(e,n)}}return g(e,[{key:"batchEvent",value:function(e){this.pendingSubmission.push(e)}},{key:"batchOn",value:function(){var e=this;this.batchIntervalHandler=setInterval(function(){try{if(e.pendingSubmission.length>0&&e.done){var t=Math.min(e.pendingSubmission.length,10),n=e.pendingSubmission.slice(0,t);e.done=!1,n.forEach(function(t){return W(t).then(function(){return e.pendingSubmission.splice(0,n.length)}).catch(v.log)})}}catch(e){v.log("exception submitting",e)}},400)}},{key:"batchOff",value:function(){this.batchIntervalHandler?clearInterval(this.batchIntervalHandler):v.log("cannot batch off, it is not on")}},{key:"override",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._dispatchEvent,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._dispatchError;this._dispatchError=t,this._dispatchEvent=e}},{key:"reset",value:function(){this._dispatchError=z,this._dispatchEvent=W}}]),e}());var V=new function(){var e=null,t=[];return function(n){for(var r=function(n){if(e=n,j())K({tenant:e}),Q.submitEvent(J("as.web.session.resumed")),v.log("session resumed");else{var r=a.referrer&&new URL(a.referrer).host,o=a.location&&new URL(a.location.toString()).host;v.log("no session, starting a new one"),N({tenant:e,referrer:r&&o&&r!==o&&!~t.indexOf(r)?r:null}),Q.submitEvent(J("as.web.session.started"))}},o={"create.custom.session":T,"set.tenant.id":r,"tenant.id.provided":r,"set.connected.partners":function(t){return function(e,t){var n=t,r=function(t){var r=t.target;if(r)if(M(r)){var o=new URL(r.href);~n.indexOf(o.host)&&(o.searchParams.set(m("PARTNER_ID_KEY"),e),o.searchParams.set(m("PARTNER_SID_KEY"),U().id),u(function(e){var t=i.sessionStorage.getItem("__as."+e);t&&o.searchParams.set(e,t)}),r.href=o.href)}else if($(r)){var a=["input","input"].map(document.createElement);a[0].name=m("PARTNER_ID_KEY"),a[0].value=e,a[1].name=m("PARTNER_SID_KEY"),a[1].value=U().id,a.forEach(function(e){e.type="hidden",r.form&&r.form.appendChild(e)})}};document.addEventListener("mousedown",r),document.addEventListener("keyup",r),document.addEventListener("touchstart",r)}(e||"",t)},"set.service.providers":function(e){return t=e},"set.partner.key":function(e,t){return m(e,t)},"set.logger.mode":v.mode,"set.metadata.transformer":F,"set.utm.aliases":function(e){f(e),K()}},s=arguments.length,c=Array(s>1?s-1:0),l=1;l<s;l++)c[l-1]=arguments[l];try{if(!B[n])return void(o[n]&&o[n].apply(o,c));Q.submitEvent(B[n].apply(B,c))}catch(e){v.force("inbox exception:",e),Q.submitError(e,{location:"processing inbox message",arguments:[event].concat(c)})}}};!function(){try{var e=window.asa&&window.asa.q||[];window.asa=V,t=a.referrer&&new URL(a.referrer).host,n=a.location&&new URL(a.location).host,t&&t!==n&&h(),e.forEach(function(e){return V.apply(null,e)})}catch(e){v.force("exception during init: ",e),Q.submitError(e,{location:"boot script"})}var t,n}()});
